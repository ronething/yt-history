<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Watch History</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #video-list {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Video Watch History</h1>
    

    <canvas id="chart-top" width="400" height="200"></canvas>

    <label for="start-date">Start Date:</label>
    <input type="date" id="start-date">
    <label for="end-date">End Date:</label>
    <input type="date" id="end-date">
    <button id="filter-button">Filter</button>

    <canvas id="chart-daily" width="400" height="200"></canvas>
    <div id="video-list">
        <h2>Videos Watched on <span id="selected-date"></span></h2>
        <ul id="video-list-items"></ul>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Fetch data from the API
            const videoDataResponse = await fetch('/api/video-data');
            const videoData = await videoDataResponse.json();

            const dailyDataResponse = await fetch('/api/daily-views');
            const dailyData = await dailyDataResponse.json();
            let dailyLabels = dailyData.map(item => item.time);
            let dailyCounts = dailyData.map(item => item.count);

            // Render the daily chart
            const ctxDaily = document.getElementById('chart-daily').getContext('2d');
            const dailyChart = new Chart(ctxDaily, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Daily Views',
                        data: dailyCounts,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    onClick: function(event, elements) {
                        console.log('onClick', event, elements);
                        console.log(elements.length);
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const date = dailyLabels[index];
                            const videos = videoData.filter(video => {
                                const videoDate = new Date(video.time).toISOString().split('T')[0]; // Convert to 'YYYY-MM-DD' format
                                return videoDate === date;
                            });
                            
                            const videoList = document.getElementById('video-list-items');
                            videoList.innerHTML = '';
                            videos.forEach(video => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.textContent = video.title;
                                a.href = video.url; // Assuming video.url contains the link to the video
                                a.target = '_blank'; // Open link in a new tab
                                li.appendChild(a);
                                videoList.appendChild(li);
                            });
                            
                            document.getElementById('selected-date').textContent = date;
                            document.getElementById('video-list').style.display = 'block';
                        }
                    }
                }
            });

            // Fetch and render top videos chart data
            const topDataResponse = await fetch('/api/top-videos');
            const topData = await topDataResponse.json();
            const topLabels = topData.map(item => item.title);
            const topCounts = topData.map(item => item.count);

            const ctxTop = document.getElementById('chart-top').getContext('2d');
            const topChart = new Chart(ctxTop, {
                type: 'bar',
                data: {
                    labels: topLabels,
                    datasets: [{
                        label: 'Top Videos',
                        data: topCounts,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                }
            });

            // Filter button event
            document.getElementById('filter-button').addEventListener('click', function() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                let filteredData;
                if (!startDate && !endDate) {
                    // If both start and end dates are empty, show all data
                    filteredData = dailyData;
                } else {
                    // Filter data based on date range
                    filteredData = dailyData.filter(item => {
                        return item.time >= startDate && item.time <= endDate;
                    });
                }

                dailyLabels = filteredData.map(item => item.time);
                dailyCounts = filteredData.map(item => item.count);

                dailyChart.data.labels = dailyLabels;
                dailyChart.data.datasets[0].data = dailyCounts;
                dailyChart.update();
            });
        });
    </script>
</body>
</html>
